name: Resource Tests

on:
  push:
    branches: [main, develop, ci-cd-terraform]
  pull_request:
    branches: [main]
  workflow_dispatch: # manual trigger

permissions:
  contents: read

jobs:
  test:
    name: Terraform Resource Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Pull latest scm-go SDK from develop
        run: |
          sed -i '/replace.*scm-go/d' go.mod
          go get github.com/paloaltonetworks/scm-go@develop
          go mod tidy

      - name: Build provider
        run: go build -o terraform-provider-scm

      - name: Configure dev_overrides
        run: |
          printf 'provider_installation {\n  dev_overrides {\n    "paloaltonetworks-local/scm" = "%s"\n  }\n  direct {}\n}\n' "${{ github.workspace }}" > ~/.terraformrc

      - name: Generate provider.tf
        env:
          SCM_HOST: ${{ secrets.SCM_HOST }}
          SCM_AUTH_URL: ${{ secrets.SCM_AUTH_URL }}
          SCM_CLIENT_ID: ${{ secrets.SCM_CLIENT_ID }}
          SCM_CLIENT_SECRET: ${{ secrets.SCM_CLIENT_SECRET }}
          SCM_SCOPE: ${{ secrets.SCM_SCOPE }}
        run: |
          printf 'provider "scm" {\n  host          = "%s"\n  auth_url      = "%s"\n  client_id     = "%s"\n  client_secret = "%s"\n  scope         = "%s"\n  logging       = "debug"\n}\n\nterraform {\n  required_providers {\n    scm = {\n      source = "paloaltonetworks-local/scm"\n    }\n  }\n}\n' "$SCM_HOST" "$SCM_AUTH_URL" "$SCM_CLIENT_ID" "$SCM_CLIENT_SECRET" "$SCM_SCOPE" > examples/provider/provider.tf

      - name: Setup test workspaces
        run: ./tests/setup.sh

      - name: Run tests
        run: ./tests/run_tests.sh --all
